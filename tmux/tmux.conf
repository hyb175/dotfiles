# =====================================
# TMUX Configuration
# =====================================

# =====================================
# Server Options
# =====================================
# Set default terminal with 256 color support
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",*256col*:Tc"

# Reduce escape time for faster key response
set -sg escape-time 0

# Enable focus events for vim compatibility
set -g focus-events on

# =====================================
# Session Options
# =====================================
# Increase scrollback buffer size
set -g history-limit 10000

# Enable mouse support for all interactions
set -g mouse on

# Set window title
set -g set-titles on
set -g set-titles-string '#S ● #I #W'

# =====================================
# Window Options
# =====================================
# Start window indices at 1 instead of 0
set -g base-index 1

# Renumber windows automatically when one is closed
set -g renumber-windows on

# Automatic window renaming based on current path/command
setw -g automatic-rename on
setw -g automatic-rename-format '#{?#{||:#{==:#{pane_current_command},zsh},#{==:#{pane_current_command},fish}},#{pane_current_command},#{?#{m/r:^[0-9]+\.[0-9]+\.[0-9]+$,#{pane_current_command}},claude,#{pane_current_command}}}(#{b:pane_current_path})'

# Monitor window activity
setw -g monitor-activity on
set -g visual-activity off
setw -g window-status-activity-style fg=colour166,bg=colour235

# Enable aggressive resize
setw -g aggressive-resize on

# =====================================
# Pane Options
# =====================================
# Start pane indices at 1 instead of 0
setw -g pane-base-index 1

# =====================================
# Key Bindings - Prefix
# =====================================
# Change prefix from Ctrl-b to Ctrl-a
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# =====================================
# Key Bindings - Config Management
# =====================================
# Reload config file with display notification
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"

# =====================================
# Key Bindings - Pane Management
# =====================================
# Split panes using | and - (more intuitive)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Navigate panes using vim-style keys
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize panes with vim-style keys (repeatable)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Quick pane cycling
bind -r Tab select-pane -t :.+

# =====================================
# Key Bindings - Session Management
# =====================================
# Create new session
bind S new-session
bind N new-session -d  # Create new session in background

# Launch development environment
bind D run-shell "~/.config/tmux/scripts/dev-env.sh"

# Open new session in mycase directory
bind L new-session -c "~/mycase/mycase_login"

# Kill current session and switch to last
bind X switch-client -l \; kill-session -t !

# =====================================
# Key Bindings - Window Management
# =====================================
# Create new window in current directory
bind c new-window -c "#{pane_current_path}"

# Navigate windows (repeatable)
bind -r n next-window
bind -r p previous-window

# =====================================
# Copy Mode Configuration
# =====================================
# Use vim keybindings in copy mode
setw -g mode-keys vi

# Enter copy mode with Prefix + Enter
bind Enter copy-mode

# Setup 'v' to begin selection as in Vim
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Update default binding of `Enter` to also use copy-pipe
unbind -T copy-mode-vi Enter

# =====================================
# Status Bar Configuration
# =====================================
# Enable status bar
set -g status on
set -g status-interval 5
set -g status-position top

# =====================================
# Theme Configuration - tmux2k with Everforest Colors
# =====================================
# Use duo theme as base for custom colors
set -g @tmux2k-theme 'duo'

# Apply everforest colors to duo theme
set -g @tmux2k-duo-fg '#d3c6aa'  # everforest fg
set -g @tmux2k-duo-bg '#2d353b'  # everforest bg0

# Minimal status bar - only essentials
set -g @tmux2k-left-plugins "session"
set -g @tmux2k-right-plugins "battery time"

# Clean, minimal appearance
set -g @tmux2k-show-powerline false

# Custom everforest colors
set -g @tmux2k-light-green '#a7c080'  # everforest green
set -g @tmux2k-light_blue '#7fbbb3'   # everforest blue
set -g @tmux2k-bg-main '#2d353b'      # everforest bg0

# =====================================
# Plugin Configuration
# =====================================
# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin '2kabhishek/tmux2k'
# set -g @plugin 'omerxx/tmux-sessionx'  # Replaced with sesh
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'

# =====================================
# Sesh Configuration (Fast Session Manager)
# =====================================
# Sesh key bindings - maximum performance
# Main session switcher (optimized fzf)
bind-key "o" display-popup -E -w 35% -h 60% \
  "sesh connect \$(sesh list --icons | fzf --no-sort --no-info --no-scrollbar --cycle --reverse --ansi --bind='tab:down,shift-tab:up,ctrl-j:accept' --prompt='⚡ ')"

# Ultra-fast shortcuts (no fzf overhead)
bind-key "O" run-shell "sesh connect \$(sesh list -t | head -1)"  # Connect to last session instantly
bind-key "C-o" run-shell "sesh connect \$(pwd)"  # Connect to current directory instantly

# =====================================
# Resurrect & Continuum Configuration
# =====================================
# Enable automatic restore when tmux is started
set -g @continuum-restore 'on'

# Save sessions automatically every 15 minutes
set -g @continuum-save-interval '15'

# Restore vim/neovim sessions
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'

# Restore pane contents
set -g @resurrect-capture-pane-contents 'on'

# Additional programs to restore
# set -g @resurrect-processes 'ssh node npm yarn "npm start" "npm run" "yarn start" "yarn dev"'

# =====================================
# Plugin Manager Initialization
# =====================================
# Initialize TMUX plugin manager (keep this line at the very bottom)
run '~/.config/tmux/plugins/tpm/tpm'